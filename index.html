<script>
    // ... [Previous variables remain]

    // --- UPDATED PHOTO HANDLING ---
    function handleFile(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const scale = Math.min(1, 1000/img.width);
                cvs.width = img.width*scale; cvs.height = img.height*scale;
                cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                selectedImageB64 = cvs.toDataURL('image/jpeg', 0.6);
                
                // NEW: Show preview and focus text area
                const preview = document.getElementById('preview-container');
                if(!preview) {
                    // Create preview element if not exists
                    const p = document.createElement('div');
                    p.id = "preview-container";
                    p.innerHTML = `<img src="${selectedImageB64}" style="width:100%; border-radius:8px; margin-top:10px;">`;
                    document.getElementById('composer-area').insertBefore(p, document.querySelector('.composer-actions'));
                } else {
                    preview.innerHTML = `<img src="${selectedImageB64}" style="width:100%; border-radius:8px; margin-top:10px;">`;
                }
                
                // AUTO-FOCUS TEXT AREA
                document.getElementById('post-text').focus();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }

    async function submitPost() {
        const textInput = document.getElementById('post-text');
        const text = textInput.value.trim();
        if (!text && !selectedImageB64) return;

        const memory = { 
            id: crypto.randomUUID(), 
            text, 
            image: selectedImageB64, 
            timestamp: Date.now(), 
            owner: userEmail 
        };

        const tx = db.transaction("memories", "readwrite");
        tx.objectStore("memories").add(memory);
        tx.oncomplete = () => {
            textInput.value = "";
            selectedImageB64 = null;
            // Clear the preview
            const preview = document.getElementById('preview-container');
            if(preview) preview.innerHTML = "";
            
            loadFeed(); // Show post instantly
            autoSync(); // Background save to Google Drive
        };
    }

    // [All other functions like loadFeed, gisInit, autoSync remain same for stability]
</script>