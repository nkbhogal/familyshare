<script>
    const ADMIN_PW = "nimda";
    const CLIENT_ID = '825926708576-1mvndhveb3qe5qhtql14dv85c5rnld74.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DB_NAME = "FamilyShare_Pro_DB";

    let tokenClient, accessToken = localStorage.getItem('google_access_token'), db;
    let isAdmin = (sessionStorage.getItem('isAdmin') === 'true');
    let userEmail = localStorage.getItem('user_email') || "";
    let selectedImageB64 = null;

    window.onload = () => { 
        openDB().then(() => { 
            loadFeed(); // Initial load from local storage
            gisInit(); 
            applySavedBranding(); 
        }); 
    };

    function openDB() {
        return new Promise((res) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => { e.target.result.createObjectStore("memories", { keyPath: "id" }); };
            req.onsuccess = e => { db = e.target.result; res(); };
        });
    }

    // --- ENHANCED PHOTO SUBMISSION ---
    async function submitPost() {
        const text = document.getElementById('post-text').value;
        if (!text && !selectedImageB64) return;

        const memory = { 
            id: crypto.randomUUID(), 
            text, 
            image: selectedImageB64, 
            timestamp: Date.now(), 
            owner: userEmail 
        };

        const tx = db.transaction("memories", "readwrite");
        tx.objectStore("memories").add(memory);
        tx.oncomplete = () => { 
            document.getElementById('post-text').value = ""; 
            selectedImageB64 = null; 
            loadFeed(); // Immediate UI update
            autoSync(); // Background cloud update
        };
    }

    // --- ROBUST SYNC LOGIC ---
    async function autoSync() {
        if (!accessToken) return;
        try {
            // 1. Get local data
            const local = await new Promise(res => {
                db.transaction("memories", "readonly").objectStore("memories").getAll().onsuccess = e => res(e.target.result);
            });

            // 2. Locate or Create family_ledger_pro.json on Drive
            const search = await fetch('https://www.googleapis.com/drive/v3/files?q=name="family_ledger_pro.json" and trashed=false', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const searchRes = await search.json();
            let fileId = (searchRes.files && searchRes.files.length > 0) ? searchRes.files[0].id : null;
            
            // 3. Download remote data to merge (Prevents losing photos from other devices)
            if (fileId) {
                const download = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (download.ok) {
                    const remoteData = await download.json();
                    const tx = db.transaction("memories", "readwrite");
                    remoteData.forEach(m => tx.objectStore("memories").put(m));
                    tx.oncomplete = () => loadFeed(); // Refresh UI with merged data
                }
            }

            // 4. Upload merged local state back to Drive
            const currentLocal = await new Promise(res => {
                db.transaction("memories", "readonly").objectStore("memories").getAll().onsuccess = e => res(e.target.result);
            });

            const metadata = { name: "family_ledger_pro.json", mimeType: "application/json" };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([JSON.stringify(currentLocal)], { type: 'application/json' }));
            
            await fetch(fileId ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart` : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: fileId ? 'PATCH' : 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}` },
                body: form
            });
        } catch (e) { 
            console.error("Sync Error:", e); 
        }
    }

    // --- IMPROVED IMAGE HANDLING ---
    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                // Limit long edge to 1200px for better performance
                const maxDim = 1200;
                let w = img.width, h = img.height;
                if (w > h && w > maxDim) { h *= maxDim / w; w = maxDim; }
                else if (h > maxDim) { w *= maxDim / h; h = maxDim; }
                
                cvs.width = w; cvs.height = h;
                cvs.getContext('2d').drawImage(img, 0, 0, w, h);
                selectedImageB64 = cvs.toDataURL('image/jpeg', 0.7);
                alert("Photo ready to post!");
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }

    // [All other UI and Sidebar functions from v9.1 remain]
</script>