<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title id="page-title">FamilyShare</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <style>
        :root { --primary: #e63946; --secondary: #457b9d; --bg: #fdf6f0; --success: #2a9d8f; --admin: #1d3557; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #333; -webkit-tap-highlight-color: transparent; }
        
        header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        #feed { max-width: 600px; margin: auto; padding: 10px; }
        
        .version-badge { font-size: 0.6rem; background: #eee; padding: 2px 6px; border-radius: 10px; cursor: pointer; color: #888; margin-left: 5px; display: inline-flex; align-items: center; gap: 4px; }
        #admin-indicator { display: none; font-size: 0.7rem; }
        
        /* Secret Admin Panel */
        #admin-panel { 
            display: none; background: var(--admin); color: white; padding: 20px; 
            position: fixed; top: 60px; left: 10px; right: 10px; border-radius: 15px; 
            z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-admin-act { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }

        .memory-card { background: white; border-radius: 18px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.06); overflow: hidden; position: relative; }
        .memory-card img { width: 100%; display: block; object-fit: cover; max-height: 500px; }
        .memory-info { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; padding: 20px 0; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 -2px 15px rgba(0,0,0,0.05); z-index: 101; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 30px; cursor: pointer; font-weight: bold; width: 80%; max-width: 300px; }
        .btn-action { background: none; border: 1px solid #ddd; color: #666; padding: 6px 12px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; }
        
        #auto-status { position: fixed; top: 70px; right: 20px; font-size: 0.7rem; background: rgba(255,255,255,0.9); padding: 5px 12px; border-radius: 20px; z-index: 200; display: flex; align-items: center; gap: 6px; }
        .dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; }
        .dot-active { background-color: var(--success); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="auto-status"><span id="status-dot" class="dot"></span> <span id="status-text">Disconnected</span></div>

<div id="admin-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0">Admin Control üîë</h3>
        <button onclick="toggleAdmin()" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
    </div>
    <div class="admin-grid">
        <button class="btn-admin-act" onclick="sendInvite('whatsapp')">üí¨ Invite (WA)</button>
        <button class="btn-admin-act" onclick="sendInvite('email')">üìß Invite (Email)</button>
        <button class="btn-admin-act" onclick="window.open('https://drive.google.com')">üìÅ Open Drive</button>
        <button class="btn-admin-act" onclick="broadcastMessage()">üì£ Broadcast</button>
        <button class="btn-admin-act" style="grid-column: span 2; background: var(--primary);" onclick="logout()">üö® Full Nuclear Reset</button>
    </div>
</div>

<header>
    <div style="width: 50px"></div>
    <h1 style="margin:0; font-size: 1.1rem; color: var(--primary);">FamilyShare <span id="ver-tag" class="version-badge" onclick="adminCheck()">v6.0<span id="admin-indicator">üîë</span></span></h1>
    <button id="logout-btn" class="btn-action" onclick="logout()">Logout</button>
</header>

<div id="feed"></div>

<div id="setup-card" class="hidden" style="margin: 20px; background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
    <h3>Welcome Home</h3>
    <button onclick="handleAuthClick()" style="background: #4285F4; color:white; border:none; padding:12px 20px; border-radius:10px; font-weight:bold; cursor:pointer;">
        Link Google Account
    </button>
</div>

<nav class="bottom-nav">
    <button class="btn-main" onclick="document.getElementById('imgIn').click()">+ New Memory</button>
</nav>

<input type="file" id="imgIn" accept="image/*" class="hidden" onchange="handlePost(event)">

<script>
    const APP_VERSION = "6.0";
    const ADMIN_PW = "nimda";
    const CLIENT_ID = '825926708576-1mvndhveb3qe5qhtql14dv85c5rnld74.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DB_NAME = "FamilyShare_DB";

    let tokenClient, accessToken = localStorage.getItem('google_access_token'), db;
    let clickCount = 0;
    let isAdminAuthenticated = false;

    // --- SECRET ADMIN ACCESS ---
    function adminCheck() {
        clickCount++;
        if (clickCount >= 5) {
            clickCount = 0;
            if (isAdminAuthenticated) {
                toggleAdmin();
            } else {
                const pw = prompt("Enter Admin Password:");
                if (pw === ADMIN_PW) {
                    isAdminAuthenticated = true;
                    document.getElementById('admin-indicator').style.display = 'inline';
                    toggleAdmin();
                } else {
                    alert("Incorrect Access Code.");
                }
            }
        }
        setTimeout(() => { clickCount = 0; }, 3000);
    }

    function toggleAdmin() {
        const panel = document.getElementById('admin-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    async function broadcastMessage() {
        const msg = prompt("Message for the family:");
        if (msg) alert("Broadcast queued for v6.1 update.");
    }

    // --- CORE APP FUNCTIONS ---
    function openDB() {
        return new Promise((resolve) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = e => {
                const d = e.target.result;
                if (!d.objectStoreNames.contains("memories")) d.createObjectStore("memories", { keyPath: "id" });
            };
            request.onsuccess = e => { db = e.target.result; resolve(); };
        });
    }

    function gisInit() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (res) => {
                accessToken = res.access_token;
                localStorage.setItem('google_access_token', accessToken);
                document.getElementById('setup-card').classList.add('hidden');
                autoSync();
            },
        });
        if (accessToken) autoSync();
        else document.getElementById('setup-card').classList.remove('hidden');
    }

    function handleAuthClick() { tokenClient.requestAccessToken({prompt: 'select_account'}); }

    async function logout() {
        if(!confirm("Nuclear Logout? Local data will be wiped.")) return;
        if (window.google) google.accounts.id.disableAutoSelect();
        if (accessToken) google.accounts.oauth2.revoke(accessToken, () => {});
        localStorage.clear();
        indexedDB.deleteDatabase(DB_NAME);
        location.reload();
    }

    async function autoSync() {
        if (!accessToken) return;
        updateStatus("Syncing...", true);
        try {
            const local = await new Promise(res => {
                db.transaction("memories", "readonly").objectStore("memories").getAll().onsuccess = e => res(e.target.result);
            });
            const search = await fetch('https://www.googleapis.com/drive/v3/files?q=name="family_ledger.json"', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const searchRes = await search.json();
            let fileId = (searchRes.files && searchRes.files.length > 0) ? searchRes.files[0].id : null;
            
            const metadata = { name: 'family_ledger.json', mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([JSON.stringify(local)], { type: 'application/json' }));

            await fetch(fileId ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart` : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: fileId ? 'PATCH' : 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}` },
                body: form
            });

            if (fileId) {
                const download = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (download.ok) {
                    const driveData = await download.json();
                    const writeTx = db.transaction("memories", "readwrite");
                    driveData.forEach(m => writeTx.objectStore("memories").put(m));
                }
            }
            updateStatus("Up to date", false);
            loadFeed();
        } catch (e) { updateStatus("Error", false); }
    }

    async function handlePost(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
            const memory = { id: crypto.randomUUID(), image: await compress(ev.target.result), timestamp: Date.now() };
            const tx = db.transaction("memories", "readwrite");
            tx.objectStore("memories").add(memory);
            tx.oncomplete = () => autoSync();
        };
        reader.readAsDataURL(file);
    }

    function loadFeed() {
        const feed = document.getElementById('feed');
        db.transaction("memories", "readonly").objectStore("memories").getAll().onsuccess = e => {
            const items = e.target.result.sort((a,b)=>b.timestamp-a.timestamp);
            feed.innerHTML = items.length ? "" : `<div style="text-align:center; padding:50px; color:#ccc;">No memories yet.</div>`;
            items.forEach(m => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.innerHTML = `<img src="${m.image}"><div class="memory-info"><small>${new Date(m.timestamp).toLocaleDateString()}</small><button class="btn-action" onclick="deletePhoto('${m.id}')">Delete</button></div>`;
                feed.appendChild(card);
            });
        };
    }

    function deletePhoto(id) {
        if(confirm("Delete this memory?")) {
            const tx = db.transaction("memories", "readwrite");
            tx.objectStore("memories").delete(id);
            tx.oncomplete = () => autoSync();
        }
    }

    function compress(b64) {
        return new Promise(res => {
            const img = new Image(); img.src = b64;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const scale = Math.min(1, 1000 / img.width);
                cvs.width = img.width * scale; cvs.height = img.height * scale;
                cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                res(cvs.toDataURL('image/jpeg', 0.6));
            }
        });
    }

    function updateStatus(text, active) {
        document.getElementById('status-text').innerText = text;
        document.getElementById('status-dot').className = active ? 'dot dot-active' : 'dot';
    }

    function sendInvite(method) {
        const msg = `Join our Private Family Album!\n\n${window.location.href}`;
        if (method === 'email') window.location.href = `mailto:?subject=FamilyShare&body=${encodeURIComponent(msg)}`;
        else window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    }

    openDB().then(() => { loadFeed(); gisInit(); });
</script>
</body>
</html>